{% extends 'base_page.html' %}

{% load compress %}
{% load js_filters %}
{% load model_filters %}
{% load static %}


{% block style_includes %}
    {{ block.super }}

    <link type='text/css' rel='stylesheet' href='{% static 'css/rating.css' %}' />
{% endblock style_includes %}


{% block script_includes %}
    {{ block.super }}

    <script type='text/javascript' src='{% static 'js/libraries/jquery.svg.package-1.4.5/jquery.svg.js' %}'></script>
    <script type='text/javascript' src='{% static 'js/libraries/jquery.svg.package-1.4.5/jquery.svgdom.js' %}'></script>

    <!-- libs -->
    {% compress js %}
        <script type='text/coffeescript' src='{% static 'coffeescript/tools.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'coffeescript/enum.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'coffeescript/svg_tools.coffee' %}'></script>
    {% endcompress %}

    <!-- character summary -->
    {% compress js %}
        <script type='text/coffeescript' src='{% static 'character/coffeescript/models/character.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/affiliation.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/creaturetype.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/genealogy.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/subgroup.coffee' %}'></script>
    {% endcompress %}

    <!-- trait models -->
    {% compress js %}
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/attribute.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/charactertext.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/combattrait.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/derangement.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/flaw.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/merit.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/misctrait.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/power.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/skill.coffee' %}'></script>
    {% endcompress %}

    <!-- character traits -->
    {% compress js %}
        <script type='text/coffeescript' src='{% static 'character/coffeescript/models/characterhasattribute.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'character/coffeescript/models/characterhascombattrait.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'character/coffeescript/models/characterhasderangement.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'character/coffeescript/models/characterhasflaw.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'character/coffeescript/models/characterhasmerit.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'character/coffeescript/models/characterhasmisctrait.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'character/coffeescript/models/characterhaspower.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'character/coffeescript/models/characterhasskill.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'character/coffeescript/models/characterhastext.coffee' %}'></script>
    {% endcompress %}

    <!-- views -->
    {% compress js %}
        <script type='text/coffeescript' src='{% static 'coffeescript/views/rating.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'character/coffeescript/views/attribute_group.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'character/coffeescript/views/edit_character_summary.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'coffeescript/collections/filtered_collection.coffee' %}'></script>
    {% endcompress %}
{% endblock script_includes %}


{% block content %}
    <script type='text/html' id='template_character-summary'>
        <div>
            <span class='label'>Player Name:</span> {{ character.user.username }}<br />
            <span class='label'>Character Status:</span> <%= status.name %><br />
            <span class='label'>Character Name:</span> <input type='text' name='name' value='<%= name %>' /><br />
            <span class='label'><%= creature_type.genealogy_name %>:</span> <select name='genealogy'></select><br />
            <span class='label'><%= creature_type.affiliation_name %>:</span> <select name='affiliation'></select><br />
            <span class='label'><%= creature_type.subgroup_name %>:</span> <select name='subgroup'></select><br />
            <span class='label'>Virtue:</span> <select name='virtue'></select><br />
            <span class='label'>Vice:</span> <select name='vice'></select><br />
        </div>
    </script>

    <script type='text/html' id='template_simple-trait-group'>
        <h3><%= header %></h3>
        <ul class='trait-list'></ul>
    </script>

    <script type='text/javascript'>
        Tools.create_namespace('Traits.Enums')
        Tools.create_namespace('Traits.Objects')

        Traits.Enums.Vice   = new Enum.Enum({{ vices   | serialize_json | safe }})
        Traits.Enums.Virtue = new Enum.Enum({{ virtues | serialize_json | safe }})

        Traits.Objects.Affiliation  = new Backbone.Collection({{ affiliations   | serialize_json | safe }}, {model: Traits.Models.Affiliation  })
        Traits.Objects.CreatureType = new Backbone.Collection({{ creature_types | serialize_json | safe }}, {model: Traits.Models.CreatureType })
        Traits.Objects.Genealogy    = new Backbone.Collection({{ genealogies    | serialize_json | safe }}, {model: Traits.Models.Genealogy    })
        Traits.Objects.Subgroup     = new Backbone.Collection({{ subgroups      | serialize_json | safe }}, {model: Traits.Models.Subgroup     })

        Traits.Enums.AttributeType   = new Enum.Enum({{ attribute_types   | serialize_json | safe }})
        Traits.Enums.DerangementType = new Enum.Enum({{ derangement_types | serialize_json | safe }})
        Traits.Enums.FlawType        = new Enum.Enum({{ flaw_types        | serialize_json | safe }})
        Traits.Enums.MeritType       = new Enum.Enum({{ merit_types       | serialize_json | safe }})
        Traits.Enums.SkillType       = new Enum.Enum({{ skill_types       | serialize_json | safe }})

        Traits.Objects.Attribute     = new Backbone.Collection({{ attributes      | serialize_json | safe }}, {model: Traits.Models.Attribute,     parse: true })
        Traits.Objects.CharacterText = new Backbone.Collection({{ character_texts | serialize_json | safe }}, {model: Traits.Models.CharacterText, parse: true })
        Traits.Objects.CombatTrait   = new Backbone.Collection({{ combat_traits   | serialize_json | safe }}, {model: Traits.Models.CombatTrait,   parse: true })
        Traits.Objects.Derangement   = new Backbone.Collection({{ derangements    | serialize_json | safe }}, {model: Traits.Models.Derangement,   parse: true })
        Traits.Objects.Flaw          = new Backbone.Collection({{ flaws           | serialize_json | safe }}, {model: Traits.Models.Flaw,          parse: true })
        Traits.Objects.Merit         = new Backbone.Collection({{ merits          | serialize_json | safe }}, {model: Traits.Models.Merit,         parse: true })
        Traits.Objects.MiscTrait     = new Backbone.Collection({{ misc_traits     | serialize_json | safe }}, {model: Traits.Models.MiscTrait,     parse: true })
        Traits.Objects.Power         = new Backbone.Collection({{ powers          | serialize_json | safe }}, {model: Traits.Models.Power,         parse: true })
        Traits.Objects.Skill         = new Backbone.Collection({{ skills          | serialize_json | safe }}, {model: Traits.Models.Skill,         parse: true })
    </script>

    <section id='general-character-traits'>
    </section>

    <section id='attributes'>
        <h2>Attributes</h2>
        {# TODO(emery): Determine width programatically. #}
        <div id='mental-attributes'   style='width: 33.33333%'></div>
        <div id='physical-attributes' style='width: 33.33333%'></div>
        <div id='social-attributes'   style='width: 33.33333%'></div>
    </section>

    {% compress js %}
    <script type='text/coffeescript'>
    $ () ->
        charcter_summary = new Character.Views.CharacterSummary
            el: $ '#general-character-traits'
            template: _.template $('#template_character-summary').html()
            model: new Character.Models.Character({{ character | serialize_json | safe }}, { parse: true })
        charcter_summary.render()


        # ATTRIBUTES

        attr_group_template = _.template $('#template_simple-trait-group').html()
        character_attributes = new Backbone.Collection {{ character_has_attribute | serialize_json | safe }},
            parse: true
            model: Character.Models.CharacterHasAttribute

        _.each Traits.Enums.AttributeType._elements, (type) ->
            target_id = type.name.toLowerCase() + '-attributes'
            attributes = new Character.Views.AttributeGroup
                el: $ '#' + target_id
                template: attr_group_template
                collection: new Tools.Collections.FilteredCollection(null,
                    base_collection: character_attributes
                    filter: (ca) ->
                        trait = ca.get 'trait'
                        type == trait.get 'type'
                )
                header: type.name
                ItemView: Character.Views.EditAttribute
                values: [1, 2, 3, 4, 5]
            attributes.render()
    </script>
    {% endcompress %}
{% endblock content %}
