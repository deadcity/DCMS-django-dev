{% extends 'base_page.html' %}

{% load compress %}
{% load js_filters %}
{% load model_filters %}
{% load static %}


{% block style_includes %}
    {{ block.super }}
    <link rel='stylesheet' type='text/css' href='{% static 'css/table.css' %}' />
{% endblock style_includes %}


{% block script_includes %}
    {{ block.super }}
    <script type='text/javascript' src='{% static 'js/libraries/underscore-1.4.4.js' %}'></script>
    <script type='text/javascript' src='{% static 'js/libraries/backbone-1.0.0.js' %}'></script>

    <!-- libs -->
    {% compress js %}
        <script type='text/coffeescript' src='{% static 'coffeescript/tools.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'coffeescript/enum.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'coffeescript/svg_tools.coffee' %}'></script>
    {% endcompress %}

    <!-- table -->
    {% compress js %}
        <script type='text/coffeescript' src='{% static 'coffeescript/table/column.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'coffeescript/table/row.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'coffeescript/table/table.coffee' %}'></script>
    {% endcompress %}

    <!-- character summary -->
    {% compress js %}
        <script type='text/coffeescript' src='{% static 'character/coffeescript/models/character.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/creaturetype.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/genealogy.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/affiliation.coffee' %}'></script>
        <script type='text/coffeescript' src='{% static 'traits/coffeescript/models/subgroup.coffee' %}'></script>
    {% endcompress %}
{% endblock script_includes %}


{% block content %}
    <script type='text/html' id='template_table-row'>
        <td><%= record.user.username      %></td>
        <td><%= record.name               %></td>
        <td><%= record.creature_type.name %></td>
        <td><%= record.genealogy.name     %></td>
        <td><%= record.affiliation.name   %></td>
        <td><%= record.status             %></td>
        <td>
            <% if (can_submit) { %>
                <button name='submit'>submit</button>
            <% } %>
        </td>
        <td>
            <% if (can_edit) { %>
                <button name='edit'>edit</button>
            <% } %>
        </td>
        <td>
            <% if (can_disable) { %>
                <button name='disable'>disable</button>
            <% } else if (can_enable) { %>
                <button name='enable'>enable</button>
            <% } %>
        </td>
    </script>

    <div style='float: left'>
        <label>
            show disabled characters
            <input type='checkbox' id='show-disabled-characters' />
        </label>
    </div>
    <table id='character-table' class='list-table stripped'></table>

    {% compress js %}
    <script type='text/coffeescript'>
        Tools.create_namespace 'Traits.Enums'
        Tools.create_namespace 'Traits.Objects'

        Traits.Enums.Vice   = new Enum.Enum {{ vices   | serialize_json | safe }}
        Traits.Enums.Virtue = new Enum.Enum {{ virtues | serialize_json | safe }}

        Traits.Objects.Affiliation  = new Backbone.Collection {{ affiliations   | serialize_json | safe }}, {model: Traits.Models.Affiliation  }
        Traits.Objects.CreatureType = new Backbone.Collection {{ creature_types | serialize_json | safe }}, {model: Traits.Models.CreatureType }
        Traits.Objects.Genealogy    = new Backbone.Collection {{ genealogies    | serialize_json | safe }}, {model: Traits.Models.Genealogy    }
        Traits.Objects.Subgroup     = new Backbone.Collection {{ subgroups      | serialize_json | safe }}, {model: Traits.Models.Subgroup     }
    </script>


    <script type='text/coffeescript'>
        character_table = new Table.Table {
            el: $ '#character-table'
            collection: new Backbone.Collection null, {model: Character.Models.Character}
            filter: (pres_model) -> pres_model.record.get 'enabled'

            columns: [
                { header: 'user' }
                { header: 'name',          field: 'name'          }
                { header: 'creature type', field: 'creature_type' }
                { header: 'clan',          field: 'clan'          }
                { header: 'covenant',      field: 'covenant'      }
                { header: 'status' }
                {}  # submit button
                {}  # edit button
                {}  # disable/enable button
            ]

            RowPresentation: class extends Table.Models.RowPresentation
                initialize: (attributes, options) ->
                    super attributes, options
                    @set 'can_submit',  options.can_submit
                    @set 'can_edit',    options.can_edit
                    @set 'can_disable', options.can_disable

                toJSON: () ->
                    attr = _.clone super
                    attr.can_submit  =     attr.record.enabled and attr.can_submit
                    attr.can_edit    =     attr.record.enabled and attr.can_edit
                    attr.can_disable =     attr.record.enabled and @attributes.can_disable
                    attr.can_enable  = not attr.record.enabled and @attributes.can_disable
                    attr

            RowView: class extends Table.Views.Row
                events: () ->
                    _.extend {}, super,
                        'click button[name="submit"]'  : 'on_submit'
                        'click button[name="edit"]'    : 'on_edit'
                        'click button[name="disable"]' : 'on_disable'
                        'click button[name="enable"]'  : 'on_enable'

                on_submit: () ->
                    # TODO(emery): change status to 'submitted'

                on_edit: () ->
                    # TODO(emery): goto character_edit page

                on_disable: () ->
                    @model.record.save 'enabled', false, patch: true

                on_enable: () ->
                    @model.record.save 'enabled', true, patch: true

            row_template: _.template $('#template_table-row').html()
        }

        {% for item in character_list %}
        character_table.collection.add {{ item.character|serialize_json|safe }},
            parse: true
            can_submit:  {{ item.can_submit  | js_bool }}
            can_edit:    {{ item.can_edit    | js_bool }}
            can_disable: {{ item.can_disable | js_bool }}
        {% endfor %}

        character_table.render()

        $('#show-disabled-characters').change () ->
            if $(@).is ':checked'
                character_table.filter null
            else
                character_table.filter (pres_model) -> pres_model.record.get 'enabled'
    </script>
    {% endcompress %}
{% endblock content %}
